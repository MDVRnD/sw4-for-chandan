---
date: last-modified
title: SW4 for Chandan
subtitle: Kindly do it
author:
  name: Sean R. Ford
  orcid: 0000-0002-0376-5792
  email: sean@llnl.gov
  affiliation: Lawrence Livermore National Laboratory
# abstract: |
    # Can you run MZZ, MXX, MYY seismograms for a layered medium in your SW4 and send me the output with the model? Kindly do it.
# bibliography: sw4-for-chandan.bib
number-sections: true
format:
  html:
    code-fold: true
    default-image-extension: png
  pdf:
    echo: false
    default-image-extension: pdf
    fig-pos: 'htbp'
    keep-tex: false
execute:
  cache: true
  freeze: true # auto
# jupyter: python3
---

# Introduction

Chandan asked, "Can you run MZZ, MXX, MYY seismograms for a layered medium in your SW4 and send me the output with the model?"

We obtained [SW4](https://computing.llnl.gov/projects/serpentine-wave-propagation) 
[v3.0](https://github.com/geodynamics/sw4/releases/tag/v3.0)
from [GitHub](https://github.com/geodynamics/sw4) 
and compiled on macos with [MPICH](https://www.mpich.org) 
using the following `make.inc` file:
```
proj = yes
# homebrew version of proj is fine
SW4ROOT = /opt/homebrew
fftw = yes
# homebrew version uses openmpi so installed fftw for mpich
FFTWHOME = /Users/ford17/Applications/fftw-3.3.10
FC = mpif90
CXX = mpicxx
# need Accelerate for blas on macos
EXTRA_LINK_FLAGS = -framework Accelerate -L/opt/homebrew/lib/gcc/current -lgfortran
```


# Method

The requirements are:

- Station at (x,y,z) = (60, 0, 0)
- Source at (x,y,z) = (10, 0, 10)
- WUS model
- PPW for 5 Hz
- Dirac (delta) source

So we use the following SW4 input `run.sw4in` file:
```
fileio pfs=1 nwriters=16 path=mxx.dir printcycle=1000
grid x=70e3 y=35e3 z=50e3 h=100
time t=60
refinement zmax=35000
block vp=7900.0 vs=4620.0 rho=3276.0 qp=60976 qs=27027
block vp=6352.0 vs=3756.5 rho=2805.6 qp=658 qs=293 z2=35000
block vp=5544.5 vs=3295.3 rho=2608.9 qp=287 qs=128 z2=8000
block vp=3406.5 vs=2008.9 rho=2215.0 qp=331 qs=147 z2=1900
source x=10e3 y=0 z=10e3 mxx=1e18 type=Dirac
rec x=60e3 y=0 z=0 file=rec sacformat=1
image mode=s y=0 cycle=1
```

Note that refinement was used for a more efficient calculation.

And to calculate the results we could use the command:
```
mpirun -np 16 sw4 mxx.sw4in
```

In practice we used many more processors available on ruby from [LC](https://hpc.llnl.gov) 
with the slurm script:
```
#SBATCH -N 36
#SBATCH -J run
#SBATCH -t 360
#SBATCH -p pbatch
#SBATCH --license=lustre1
#SBATCH -A gmp
#SBATCH -o run.sw4out
#SBATCH -e run.sw4err

# Max: 1440 minutes (24 hours) on 520 nodes

# Set CPUS/nodes for RUBY (limit 520 nodes for 24 hours)
@ CPUSPERNODE = 56
# Compute number of CPUs
@ NCPUS = ( $SLURM_JOB_NUM_NODES * $CPUSPERNODE )

srun -n$NCPUS /usr/workspace/ford17/sw4/optimize_ruby_mp/sw4 mxx.sw4in
srun -n$NCPUS /usr/workspace/ford17/sw4/optimize_ruby_mp/sw4 myy.sw4in
srun -n$NCPUS /usr/workspace/ford17/sw4/optimize_ruby_mp/sw4 mzz.sw4in
```

Our goal for an accurate calculation is to have a minimum points per wavelength (PPW) of between 6 and 10.
The PPW is related to the smallest wave velocity $v$ [m/s] divided by the grid spacing $h$ [m] divided by the maximum frequency represented $f$ [1/s]. For the grid used here ($v = 2008.9$ m/s, $h = 50$ m) the points per wavelength for a 5 Hz maximum frequency is:

$$
\text{PPW} = v / h / f = 2008.9 / 50 / 5 \approxeq 8 
$$


# Results

The shear wave velocity model is shown in @fig-model.

```{python}
%%script bash

visit -cli -nowin -quiet << FIN &> /dev/null
#
OpenDatabase("/Users/ford17/Development/sw4-for-chandan/SW4/mxx.dir/image.cycle=0001.y=0.s.sw4img")
AddPlot("Pseudocolor", "cs")
DrawPlots()
#
# View3DAtts = View3DAttributes()
View3DAtts = GetView3D()  # This is better since it gets the window optimized attributes
View3DAtts.viewNormal = (0, 1, 0)
View3DAtts.viewUp = (0, 0, -1)
SetView3D(View3DAtts)
#
# s.screenCapture = 0 
SaveWindowAtts = SaveWindowAttributes()
# SaveWindowAtts.outputToCurrentDirectory = 0  # required
# SaveWindowAtts.outputDirectory = "/Users/Ford17/Development/sw4-for-chandan/images"
SaveWindowAtts.outputToCurrentDirectory = 1
SaveWindowAtts.fileName = "fig-model"
SaveWindowAtts.family = 0  # do not append number
SaveWindowAtts.format = SaveWindowAtts.POSTSCRIPT  # BMP, JPEG, PNG, POSTSCRIPT, PPM, RGB, STL, TIFF, ULTRA, VTK
SaveWindowAtts.width = 2048
SaveWindowAtts.height = 2048
SetSaveWindowAttributes(SaveWindowAtts)
SaveWindow()
#
quit()
FIN

gmt psconvert fig-model.ps -A -Tfg

/bin/rm visitlog.py
```

![Shear wave velocity model plotted with [VisIt](https://visit.llnl.gov/)](fig-model){#fig-model}

Calculated displacements low passed at 5 Hz are shown in @fig-results.

```{python}
#| label: fig-results
#| fig-cap: "Calculated displacements low passed at 5 Hz plotted with [ObsPy](https://www.obspy.org)."
#| fig-subcap:
#|   - "MXX"
#|   - "MYY"
#|   - "MZZ"
#| layout-nrow: 3

# import matplotlib.pyplot as plt
from obspy import read

for comp in ("mxx", "myy", "mzz"):
    stream = read("SW4/"+comp+".dir/rec.?", format="SAC")
    b = stream[0].stats.starttime; ti = b+5; tf = b+35;
    stream.filter('lowpass', freq=5.0)
    # print(comp)
    for tr in stream:
        tr.stats.station = comp
    stream.plot(starttime=b+5, endtime=b+35, type='relative');
```


# Comparison with CPS

Dispalcements are also calculated using [CPS](https://rbherrmann.github.io/ComputerProgramsSeismology/index.html)
and shown in @fig-cps.

[Bob Herrmann](https://www.slu.edu/science-and-engineering/academics/earth-atmospheric-sciences/faculty/herrmann-robert.php)
produced an
[excellent tutorial](https://rbherrmann.github.io/ComputerProgramsSeismology/TUTORIAL/SW4CPS/index.html)
that guided our work here.
In that tutorial, Bob found "execellent agreement" between SW4 and CPS.
<!-- Bob used a triangular pulse source-time function and convolved the recordings with a triangle of 1 s duration. -->
<!-- The Z, N and E synthetics thus created are for moment tensor elements of 1.0e+25 dyne-cm. The equivalent strengths used in the SW4 simulations are a moment of 1.0e+18 nt-m. -->

```{python}
#| label: fig-cps
#| fig-cap: "Calculated displacements using CPS low passed at 5 Hz plotted with [ObsPy](https://www.obspy.org)."
#| fig-subcap:
#|   - "MXX"
#|   - "MYY"
#|   - "MZZ"
#| layout-nrow: 3

# import matplotlib.pyplot as plt
from obspy import read

for comp in ("XX", "YY", "ZZ"):
    stream = read("CPS/"+comp+"/006000100.?0", format="SAC")
    b = stream[0].stats.starttime; ti = b+5; tf = b+35;
    stream.filter('lowpass', freq=5.0)
    # print(comp)
    for tr in stream:
        tr.stats.station = comp
    stream.plot(starttime=b+9, endtime=b+39, type='relative');
```

# Conclusions

SW4 and CPS are excellent tools for wavefield calculations.